resource "random_pet" "lb_hostname" {
  
}

resource "azurerm_resource_group" "rg" {
    name = "vmss-terraform"
    location = "eastus"

}


resource "azurerm_virtual_network" "vnet" {

    name = "vmssterravnet"
    address_space = ["10.0.0.0/16"]
    location = azurerm_resource_group.rg.location
    resource_group_name = azurerm_resource_group.rg.name
  
}

resource "azurerm_subnet" "subnet" {
   name = "subnet"
   resource_group_name = azurerm_resource_group.rg.name
   virtual_network_name = azurerm_virtual_network.vnet.name
   address_prefixes = ["10.0.0.0/20"]
  
}


resource "azurerm_network_security_group" "vmssNsg" {
    name = "vmssNSG"
    resource_group_name = azurerm_resource_group.rg.name
    location = azurerm_resource_group.rg.location

    security_rule {
        name = "allow-http"
        priority = 100
        direction = "Inbound"
        access = "allow"
        protocol = "Tcp"
        source_port_range = "*"
        destination_port_range = "80"
        source_address_prefix = "*"
        destination_address_prefix = "*"
    }

    security_rule {
        name = "allow-https"
        priority = 101
        direction = "Inbound"
        access = "allow"
        protocol = "Tcp"
        source_port_range = "*"
        destination_port_range = "443"
        source_address_prefix = "*"
        destination_address_prefix = "*"
    }


    security_rule {
        name = "allow-ssh"
        priority = 103
        direction = "Inbound"
        access = "allow"
        protocol = "Tcp"
        source_port_range = "*"
        destination_port_range = "22"
        source_address_prefix = "*"
        destination_address_prefix = "*"
    }
  
}


resource "azurerm_subnet_network_security_group_association" "vmssNsg" {

    subnet_id = azurerm_subnet.subnet.id
    network_security_group_id = azurerm_network_security_group.vmssNsg.id

}

resource "azurerm_public_ip" "example" {

    name = "lb-publicip"
    location = azurerm_resource_group.rg.location
    resource_group_name = azurerm_resource_group.rg.name
    allocation_method = "static"
    sku = "Standard"
    zones = ["1", "2", "3"]
    domain_name_label = "${azurerm_resource_group.rg.name}-${random_pet.lb_hostname.id}"
  
}

resource "azurerm_lb" "example" {

    resource_group_name = azurerm_resource_group.rg.name
    name = "myLB"
    location = azurerm_resource_group.rg.location
    sku = "Standard"
    frontend_ip_configuration {
      name = "myPublicIP"
      public_ip_address_id = azurerm_public_ip.example.id

    }
  
}